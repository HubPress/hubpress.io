:hp-tags: linux, mesos, marathon, openam, forgerock
# Deploying openAM 12 on mesos

I am not the one who chose openAM but the preject devs decided it is a good solution and should be used for our SSO infra. + 
OK good enough for me. Seeing that openAM is a war file that i can just run in a jvm with jetty or tomcat I thought it was a good idea to to deploy that on our mesos cluster. +
Going through the docs, they do provide options to store the config in a seperate backend and anyway users are stored in an LDAP, so that seemed like a good start. +

*Credits first.*  +
There is a lot of docs for openAM althouogh not always accurate or clear, at least there's a good amount. +
 
 * https://backstage.forgerock.com/#!/docs/openam/12.0.0/ +

Then there are 2 blog posts that helped me a lot in understanding why things were not working. +
 
 * http://azlabs.blogspot.fr/2015/08/openam-12-sessions.html
 * http://blogs.forgerock.org/petermajor/2015/08/sessions/

## Objective
 
 * openAM deployed on the Mesos/Marathon cluster with multiple instaces for HA 
 * openDJ in the backend

Now that may not be so easy, openAM is not a stateless app. and here are a few reasons why it is difficult

 * if you have read the blog posts above about openAM sessions, you'd notice that sessions are owned/associated with the host (openAM) that created it
 * openAM does not remove dead hosts from its "cluster" and cleanup is not trivial as seen in this blog post http://azlabs.blogspot.fr/2015/11/ssoadm-cli-for-scaling-and-de-scaling.html
 
## Details

Here is the marathon app definition `openam.json`
```
{
  "id": "openam",
  "cmd":"bash -x startup.sh",
  "cpus": 2,
  "mem": 1024,
  "env": {
    "OPENDJ_SERVER":"opendj.example.com",
    "OPENDJ_USER":"cn=admin",
    "OPENDJ_PASS":"password",
    "OPENAM_SUFFIX":"dc=openam,dc=example,dc=com",
    "JAVA_HOME": "/usr/lib/jvm/jre-1.8.0/bin"
  },
  "instances": 2,
  "ports": [
    31080
  ],
  "requirePorts": true,
  "constraints":[
    ["hostname","LIKE","slave0[1,2]"]
  ],
  "healthChecks": [{
    "path": "/auth/isAlive.jsp",
    "protocol": "HTTP",
    "portIndex": 0,
    "gracePeriodSeconds": 300,
    "intervalSeconds": 60,
    "timeoutSeconds": 20,
    "maxConsecutiveFailures": 3,
    "ignoreHttp1xx": false
  }],
  "uris": [
    "http://fileserver.example.com/openam-configurator-12.0.0.zip",
    "http://fileserver.example.com/jetty.tar.gz",
    "http://fileserver.example.com/openam.war",
    "http://fileserver.example.com/startup.sh"

  ]
}

```
Now for some explanations

```
"ports": [
    31080
],
"requirePorts": true,

```
This part will tell Marathon to always assign PORT 31080 to openAM 
```
"constraints":[
  ["hostname","LIKE","slave0[1,2]"]
],
```
This line will instruct Marathon to only launch on slaves 1 and 2 
_startup.sh_ is a bash script that start openam on jetty, waits for it to be fully started by looking at the log file for *Server:main: Started*, then it will launch the openam-configurator tool to configure openAM. +
openam-configurator takes in a config file +
openam.config
```
# Server properties
SERVER_URL=http://${HOSTNAME}:${PORT0}
DEPLOYMENT_URI=/openam
BASE_DIR=/tmp/openam
locale=en_US
PLATFORM_LOCALE=en_US
AM_ENC_KEY='some_random_string'
ADMIN_PWD='a_good_pass'
AMLDAPUSERPASSWD='another_good_pass'
COOKIE_DOMAIN=.eample.com
ACCEPT_LICENSES=true

# External configuration data store
DATA_STORE=dirServer
DIRECTORY_SSL=SIMPLE
DIRECTORY_SERVER=${OPENDJ_SERVER}
DIRECTORY_PORT=${OPENDJ_PORT}
DIRECTORY_ADMIN_PORT=${OPENDJ_ADMIN_PORT}
ROOT_SUFFIX=$OPENAM_SUFFIX
DS_DIRMGRDN=${OPENDJ_USER}
DS_DIRMGRPASSWD=${OPENDJ_PASS}

# External User store
USERSTORE_TYPE=LDAPv3ForOpenDS
USERSTORE_SSL=SIMPLE
USERSTORE_HOST=${OPENDJ_SERVER}
USERSTORE_PORT=${OPENDJ_PORT}
USERSTORE_SUFFIX=ou=people,dc=example, dc=com
USERSTORE_MGRDN=${OPENDJ_USER}
USERSTORE_PASSWD=${OPENDJ_PASS}

# Site config
# TODO: make it dynamic
LB_SITE_NAME=example
LB_PRIMARY_URL=http://sso.example.com:80/openam
LB_SESSION_HA_SFO=true
```
This config will make openam not use its embedded database, but use the openDJ cluster this way openam is almost _stateless_. Now everytime Marathon (re)starts openam it will start it and configure it with openDJ as its confid backend. If openAM was configured before it will not attempt to reconfigure it.

After that successfully finishing the health check from the json file will become good.and the app is considered started. +

After that I use the openam-ssoAdminTools to handle the sso part.

